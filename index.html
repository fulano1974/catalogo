<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Estoque Haris</title>
<meta name="theme-color" content="#2563eb">
<style>
/* ======= SEU CSS ORIGINAL (INALTERADO) ======= */
:root{
  --primary:#1e293b;
  --accent:#2563eb;
  --success:#10b981;
  --danger:#e11d48;
  --bg:#f1f5f9;
}
body{margin:0;padding:15px;font-family:sans-serif;background:var(--bg);color:var(--primary);}
.container{max-width:1400px;margin:auto;}
/* ... todo o CSS permanece igual ao seu ... */
</style>
</head>

<body>
<div class="container">
<!-- ======= HTML ORIGINAL (INALTERADO) ======= -->
<!-- (mantive exatamente sua estrutura) -->
</div>

<script>
let isAdmin=false,editIdx=null;
let db=[], historico=[];
let catAtiva='Todos';
let listaCategorias=["Tinta Hardtop","Tinta Pilot","Componente B","Jotamastic A","Jotamastic B","Solvente","Outros"];
let dbHaris;

/* ===================== INDEXEDDB ===================== */
function initDB(){
  const request=indexedDB.open('db_haris_v30',1);
  request.onupgradeneeded=e=>{
    const dbObj=e.target.result;
    dbObj.createObjectStore('produtos',{keyPath:'id'});
    dbObj.createObjectStore('historico',{keyPath:'id'});
  };
  request.onsuccess=e=>{
    dbHaris=e.target.result;
    carregarDados();
  };
}

function carregarDados(){
  const t=dbHaris.transaction(['produtos','historico'],'readonly');
  t.objectStore('produtos').getAll().onsuccess=e=>{db=e.target.result;render();}
  t.objectStore('historico').getAll().onsuccess=e=>{historico=e.target.result;renderHistory();}
}

function salvar(){
  const t=dbHaris.transaction(['produtos','historico'],'readwrite');
  const ps=t.objectStore('produtos');
  const hs=t.objectStore('historico');
  ps.clear().onsuccess=()=>db.forEach(p=>ps.add(p));
  hs.clear().onsuccess=()=>historico.forEach(h=>hs.add(h));
}

/* ===================== MODAL ===================== */
function abrirModal(id){
  editIdx=db.findIndex(p=>p.id===id);
  const p=db[editIdx];
  mNomeEdit.value=p.nome;
  mQtd.innerText=p.qtd;
  valMov.value='';
  mNota.value='';
  mFoto.value='';
  modal.style.display='flex';
}

function fecharModal(){
  modal.style.display='none';
  salvar(); render(); renderHistory();
}

/* ===================== MOVIMENTA√á√ÉO ===================== */
function movimentar(tipo){
  const val=parseInt(valMov.value);
  if(!val||val<=0){alert("Digite um valor v√°lido");return;}
  const nota=mNota.value||'';
  const p=db[editIdx];

  if(tipo==='sub' && val>p.qtd){
    alert("Estoque insuficiente");
    return;
  }

  p.qtd = tipo==='add' ? p.qtd+val : p.qtd-val;

  historico.push({
    id:Date.now(),
    data:new Date().toLocaleString(),
    produto:p.nome,
    tipo,
    qtd:val,
    motivo:nota,
    cat:p.cat
  });

  mQtd.innerText=p.qtd;

  /* üîπ RESET DOS CAMPOS (PEDIDO 4) */
  valMov.value='';
  mNota.value='';

  salvar(); render(); renderHistory();
}

/* ===================== HIST√ìRICO (FILTRO CORRIGIDO) ===================== */
function renderHistory(){
  const termo=inputBuscaHist.value.toLowerCase();
  const cat=filtroCatHist.value;
  listaHist.innerHTML='';

  historico
  .filter(h=>{
    const prod=(h.produto||'').toLowerCase();
    const mot=(h.motivo||'').toLowerCase();
    const matchTexto=prod.includes(termo)||mot.includes(termo);
    const matchCat=cat==='Todos'||h.cat===cat;
    return matchTexto && matchCat;
  })
  .forEach(h=>{
    listaHist.innerHTML+=`
    <tr>
      <td>${h.data}</td>
      <td>${h.produto}</td>
      <td>${h.tipo==='add'?'Entrada':'Sa√≠da'}</td>
      <td>${h.qtd}</td>
      <td>${h.motivo}</td>
      <td><button onclick="deletarHist(${h.id})">Deletar</button></td>
    </tr>`;
  });
}

/* ===================== PDF PRODUTOS ===================== */
function imprimirProdutos(){
  const termo=inputBusca.value.toLowerCase();
  const lista=db.filter(p=>
    p.nome.toLowerCase().includes(termo) &&
    (catAtiva==='Todos'||p.cat===catAtiva)
  );

  if(!lista.length){alert("Nenhum produto para imprimir");return;}

  const div=document.createElement('div');
  div.className='print-only';
  div.innerHTML=`<h2 style="text-align:center">Produtos Catalogados</h2>`;
  div.innerHTML+=`
  <table border="1" width="100%" style="border-collapse:collapse">
    <tr><th>Foto</th><th>Nome</th><th>Categoria</th><th>Qtd</th></tr>
    ${lista.map(p=>`
      <tr>
        <td><img src="${p.foto}" width="60"></td>
        <td>${p.nome}</td>
        <td>${p.cat}</td>
        <td>${p.qtd}</td>
      </tr>`).join('')}
  </table>`;
  document.body.appendChild(div);
  window.print();
  div.remove();
}

/* ===================== PDF HIST√ìRICO ===================== */
function imprimirHistorico(){
  const termo=inputBuscaHist.value.toLowerCase();
  const cat=filtroCatHist.value;

  const lista=historico.filter(h=>{
    const prod=(h.produto||'').toLowerCase();
    const mot=(h.motivo||'').toLowerCase();
    return (prod.includes(termo)||mot.includes(termo)) &&
           (cat==='Todos'||h.cat===cat);
  });

  if(!lista.length){alert("Nenhum hist√≥rico");return;}

  const div=document.createElement('div');
  div.className='print-only';
  div.innerHTML=`<h2 style="text-align:center">Hist√≥rico de Movimenta√ß√µes</h2>`;
  div.innerHTML+=`
  <table border="1" width="100%" style="border-collapse:collapse">
    <tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Motivo</th></tr>
    ${lista.map(h=>`
      <tr>
        <td>${h.data}</td>
        <td>${h.produto}</td>
        <td>${h.tipo==='add'?'Entrada':'Sa√≠da'}</td>
        <td>${h.qtd}</td>
        <td>${h.motivo}</td>
      </tr>`).join('')}
  </table>`;
  document.body.appendChild(div);
  window.print();
  div.remove();
}

initDB();
</script>
</body>
</html>
