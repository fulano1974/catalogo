<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Estoque Haris</title>
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3238/3238058.png"> <!-- √çcone de caixa -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"> <!-- Fonte Poppins -->
<style>
:root{
  --primary:#1f2a40; /* Azul escuro quase preto */
  --accent:#3b82f6; /* Azul vibrante */
  --success:#10b981;
  --danger:#ef4444;
  --bg:#f8fafc; /* Fundo mais claro */
  --card-bg:white;
  --text-color:#334155;
  --subtle-text:#64748b;
  --border-color:#e2e8f0;
}
body{
  margin:0;
  padding:0;
  font-family:'Poppins', sans-serif;
  background-color:var(--bg);
  color:var(--text-color);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  background-image:url('https://source.unsplash.com/random/1920x1080/?warehouse,logistics,abstract'); /* Imagem de fundo aleat√≥ria */
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}
.overlay{
  background-color:rgba(248, 250, 252, 0.85); /* Overlay para a imagem de fundo */
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
.container-wrapper{
  display:flex;
  flex:1;
  max-width:1600px; /* Aumentado para acomodar sidebars */
  margin:20px auto;
  gap:20px;
  padding:0 20px;
}
.sidebar{
  width:280px;
  background:var(--card-bg);
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
  display:flex;
  flex-direction:column;
  gap:15px;
  flex-shrink:0; /* N√£o encolher a sidebar */
  /* NOVAS PROPRIEDADES PARA FIXAR */
  position: sticky;
  top: 20px; /* Alinha com a margem superior do container-wrapper */
  max-height: calc(100vh - 40px); /* Altura m√°xima da viewport menos as margens */
  overflow-y: auto; /* Adiciona scroll se o conte√∫do for maior que a tela */
}
.sidebar.left{
  order:1; /* Ordem para layout */
}
.sidebar.right{
  order:3; /* Ordem para layout */
}
.main-content{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:20px;
  order:2; /* Ordem para layout */
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:var(--card-bg);
  padding:15px 25px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
.header h1{
  font-size:1.8rem;
  margin:0;
  color:var(--primary);
  display:flex;
  align-items:center;
  gap:8px;
}
.header h1 span{
  color:var(--accent);
}
.search-container{
  flex:1;
  display:flex;
  gap:10px;
  align-items:center;
  max-width:500px;
}
.search-input{
  flex:1;
  padding:10px 15px;
  border-radius:8px;
  border:1px solid var(--border-color);
  font-size:0.9rem;
  transition:all 0.3s ease;
}
.search-input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(59, 130, 246, 0.2);
  outline:none;
}
.sort-select{
  width:120px;
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border-color);
  background:var(--card-bg);
  font-size:0.85rem;
  appearance:none; /* Remover estilo padr√£o do select */
  background-image:url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.6-6.4H18.9c-5%200-9.3%201.8-12.9%205.4s-5.4%207.9-5.4%2012.8c0%204.8%201.8%209.1%205.4%2012.7L128.5%20287c3.6%203.5%207.8%205.3%2012.8%205.3s9.2-1.8%2012.8-5.3L287%2095.8a17.5%2017.5%200%200%200%205.3-12.7c0-5-1.8-9.2-5.3-12.7z%22%2F%3E%3C%2Fsvg%3E');
  background-repeat:no-repeat;
  background-position:right 0.7em top 50%, 0 0;
  background-size:0.65em auto, 100%;
}
.nav-btns{
  display:flex;
  gap:10px;
}
.btn-primary{
  padding:10px 18px;
  border-radius:30px;
  border:none;
  background:var(--accent);
  color:white;
  cursor:pointer;
  font-size:0.85rem;
  font-weight:600;
  transition:all 0.3s ease;
  box-shadow:0 2px 8px rgba(59, 130, 246, 0.3);
}
.btn-primary:hover{
  background:#2c67d3;
  box-shadow:0 4px 12px rgba(59, 130, 246, 0.4);
}
.btn-secondary{
  padding:10px 18px;
  border-radius:30px;
  border:1px solid var(--border-color);
  background:var(--card-bg);
  color:var(--primary);
  cursor:pointer;
  font-size:0.85rem;
  font-weight:600;
  transition:all 0.3s ease;
  box-shadow:0 2px 5px rgba(0,0,0,0.03);
}
.btn-secondary:hover{
  background:#f0f2f5;
  border-color:#d0d7e0;
}

/* Categoria Filters */
.cat-filter-wrapper{
  background:var(--card-bg);
  padding:15px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
.cat-filter-wrapper h3{
  font-size:1rem;
  margin-top:0;
  margin-bottom:10px;
  color:var(--primary);
}
.cat-filter{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.btn-cat{
  padding:8px 15px;
  border-radius:20px;
  border:1px solid var(--border-color);
  background:var(--card-bg);
  cursor:pointer;
  font-size:0.8rem;
  transition:all 0.3s ease;
  white-space:nowrap;
  color:var(--subtle-text);
  font-weight:500;
}
.btn-cat.active{
  background:var(--accent);
  color:white;
  border-color:var(--accent);
  box-shadow:0 2px 8px rgba(59, 130, 246, 0.2);
}
.btn-cat:hover:not(.active){
  background:#f0f2f5;
  border-color:#d0d7e0;
}

/* Imagem na sidebar */
.sidebar-image {
  width: 100%;
  padding: 0;
  margin: 0; /* Remove margens padr√£o */
  border-radius: 12px; /* Mant√©m o arredondamento da sidebar */
  overflow: hidden; /* Garante que a imagem n√£o vaze do border-radius */
  box-shadow:0 4px 12px rgba(0,0,0,0.05); /* Adiciona sombra consistente */
  display: flex; /* Para centralizar a imagem dentro do cont√™iner */
  justify-content: center; /* Centraliza horizontalmente */
  align-items: center; /* Centraliza verticalmente */
}

.sidebar-image img {
  max-width: 100%; /* Garante que a imagem n√£o ultrapasse a largura do pai */
  max-height: 100%; /* Garante que a imagem n√£o ultrapasse a altura do pai */
  height: auto; /* Mant√©m a propor√ß√£o da imagem */
  object-fit: contain;
  display: block; /* Remove espa√ßo extra abaixo da imagem */
  border-radius: 12px; /* Garante o arredondamento da imagem */
}

/* Admin Panel */
#adminPanel{
  display:none;
  background:var(--card-bg);
  padding:20px;
  border-radius:12px;
  grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
  gap:15px;
  align-items:end;
  border-left:5px solid var(--accent);
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
.input-group label{
  font-size:0.7rem;
  font-weight:600;
  color:var(--subtle-text);
  margin-bottom:5px;
  display:block;
}
input,select,textarea{
  padding:10px 12px;
  border:1px solid var(--border-color);
  border-radius:8px;
  width:100%;
  box-sizing:border-box;
  font-size:0.9rem;
  background-color:var(--bg);
  color:var(--text-color);
  transition:all 0.3s ease;
}
input:focus,select:focus,textarea:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(59, 130, 246, 0.2);
  outline:none;
  background-color:white;
}
/* IN√çCIO DA MELHORIA 5: Valida√ß√£o Visual */
.input-group.error input,
.input-group.error select,
.input-group.error textarea {
  border-color: var(--danger)!important;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2)!important;
}
.error-message {
  color: var(--danger);
  font-size: 0.75rem;
  margin-top: 5px;
  display: none; /* Escondido por padr√£o */
}
.input-group.error.error-message {
  display: block; /* Mostra a mensagem de erro */
}
/* FIM DA MELHORIA 5 */
#adminPanel button{
  height:40px;
  font-size:0.9rem;
  padding:0 20px;
}

/* Stats Bar */
.stats-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:var(--card-bg);
  padding:15px 25px;
  border-radius:12px;
  border:1px solid var(--border-color);
  font-size:0.9rem;
  box-shadow:0 2px 8px rgba(0,0,0,0.03);
}
.stats-bar > div{
  display:flex;
  gap:20px;
}
.stats-bar b{
  font-weight:700;
  color:var(--primary);
  font-size:1rem;
}
.backup-group{
  display:none;
  gap:10px;
}
.backup-group button{
  padding:8px 15px;
  border-radius:20px;
  font-size:0.8rem;
}

/* History Panel */
#historyPanel{
  display:none;
  background:var(--card-bg);
  padding:25px;
  border-radius:16px;
  margin-bottom:20px;
  border-left:5px solid var(--primary);
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
#historyPanel h2{
  font-size:1.3rem;
  margin:0;
  color:var(--primary);
}
.hist-table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:0.85rem;
}
.hist-table th,.hist-table td{
  padding:12px;
  text-align:left;
  border-bottom:1px solid #e0e7ee;
}
.hist-table th{
  background-color:#f0f4f8;
  font-weight:600;
  color:var(--primary);
}
.hist-table tr:nth-child(even){background:#f9fbfc;}
.hist-table input{font-weight:bold;font-family:inherit;}
.tag-add{color:var(--success);font-weight:bold;}
.tag-sub{color:var(--danger);font-weight:bold;}
.lixeira{
  background:#fef2f2;
  border:none;
  border-radius:5px;
  color:var(--danger);
  font-size:1rem;
  cursor:pointer;
  padding:5px 8px;
  transition:all 0.2s ease;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.lixeira:hover{
  background:var(--danger);
  color:white;
}

/* Vitrine Grid */
.grid{
  display:grid;
  /* MODIFICADO: Min-width dos cards para 150px e at√© 6 colunas */
  grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); 
  gap:20px;
}
.card{
  background:var(--card-bg);
  border-radius:12px;
  overflow:hidden;
  border:1px solid var(--border-color);
  text-align:center;
  transition:all 0.3s ease;
  padding:15px;
  box-shadow:0 4px 15px rgba(0,0,0,0.05);
  position:relative;
}
.card:hover{
  transform:translateY(-5px);
  box-shadow:0 8px 25px rgba(0,0,0,0.1);
}
.card img{
  width:100%;
  height:120px; /* Altura da imagem um pouco menor */
  object-fit:contain;
  background:#fefefe;
  border-radius:8px;
  margin-bottom:8px; /* Margem menor */
}
.card-info{
  padding:8px 0;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.card h3{
  margin:4px 0; /* Margem menor */
  font-size:0.9rem; /* FONTE DO NOME DO PRODUTO REDUZIDA */
  line-height:1.2; /* Linha um pouco mais justa */
  color:var(--primary);
  font-weight:600;
}
.badge-cat{
  font-size:0.6rem; /* FONTE DA CATEGORIA REDUZIDA */
  padding:3px 8px; /* Padding menor */
  border-radius:15px;
  color:white;
  font-weight:600;
  text-transform:uppercase;
  margin-top:4px; /* Margem menor */
  margin-bottom:8px; /* Margem menor */
  display:inline-block; /* Para padding funcionar bem */
}
.card p{
  margin:0;
  font-size:0.75rem; /* FONTE DO TEXTO 'ESTOQUE' REDUZIDA */
  color:var(--subtle-text);
}
.card p b{
  font-size:1rem; /* FONTE DO N√öMERO DO ESTOQUE REDUZIDA */
  color:var(--primary);
}
.admin-actions{
  display:flex;
  flex-direction:row;
  justify-content:center;
  gap:8px;
  margin-top:10px;
}
.btn-edit-card,.btn-delete-card{
  font-size:0.75rem;
  padding:6px 10px;
  background:#f0f4f8;
  border:1px solid var(--border-color); /* Usando vari√°vel */
  border-radius:6px;
  cursor:pointer;
  color:var(--primary);
  transition:all 0.2s ease;
}
.btn-edit-card:hover{background:#e0e7ee;}
.btn-delete-card{
  background:#fef2f2;
  border-color:#fca5a5;
  color:#b91c1c;
}
.btn-delete-card:hover{
  background:#b91c1c;
  color:white;
}

/* Modal Styling - REVISADO */
#modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(15,23,42,0.7);
  z-index:1000;
  align-items:center;
  justify-content:center;
  backdrop-filter:blur(5px);
}
.modal-content{
  background:var(--card-bg);
  padding:30px;
  border-radius:20px;
  width:400px; /* Aumentado para melhor layout */
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
  transform:scale(0.95);
  animation:modalOpen 0.3s forwards ease-out;
  display:flex;
  flex-direction:column;
  gap:15px; /* Espa√ßamento entre os elementos do modal */
}
@keyframes modalOpen {
  to { transform:scale(1); opacity:1; }
}
.modal-content h2.modal-title{ /* Novo t√≠tulo para o modal */
  font-size:1.4rem;
  color:var(--primary);
  margin:0 0 10px 0;
  font-weight:700;
}
.modal-content.input-group{ /* Reutilizando estilo de input-group */
  text-align:left;
  margin-bottom:5px;
}
.modal-content.input-group label{
  font-size:0.85rem;
  font-weight:600;
  color:var(--subtle-text);
  margin-bottom:5px;
  display:block;
}
.modal-content input,
.modal-content select,
.modal-content textarea {
  width:100%;
  padding:10px 12px;
  border:1px solid var(--border-color);
  border-radius:8px;
  box-sizing:border-box;
  font-size:0.9rem;
  background-color:var(--bg);
  color:var(--text-color);
  transition:all 0.3s ease;
}
input:focus,select:focus,textarea:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(59, 130, 246, 0.2);
  outline:none;
  background-color:white;
}

#mNomeEdit{ /* Estilo espec√≠fico para o nome do produto */
  font-weight:600;
  text-align:center;
  font-size:1.1rem;
  color:var(--primary);
  background:var(--bg);
  border-color:var(--border-color);
}
.current-stock-display{
  background:#f0f4f8;
  padding:10px;
  border-radius:10px;
  margin-bottom:5px;
}
.current-stock-display p{
  margin:0;
  font-size:0.7rem;
  color:var(--subtle-text);
}
.current-stock-display b{
  font-size:1.8rem;
  color:var(--primary);
}
#valMov{
  text-align:center;
  width:100px; /* Ajustado para caber no layout */
  margin:auto;
  background:var(--bg);
  border-color:var(--border-color);
}
#mNota{
  height:60px;
  font-size:0.8rem;
  resize:vertical;
  background:var(--bg);
  border-color:var(--border-color);
}
.file-upload-group{
  margin-top:5px;
  text-align:left;
}
.file-upload-group label{
  display:block;
  margin-bottom:5px;
  font-weight:500;
  color:var(--subtle-text);
  font-size:0.85rem;
}
.file-upload-group input[type="file"]{
  padding:8px;
  border:1px solid var(--border-color);
  border-radius:8px;
  background-color:var(--bg);
  font-size:0.8rem;
  cursor:pointer;
}
.modal-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.modal-actions button{
  flex:1;
  padding:12px;
  border-radius:10px;
  font-size:0.9rem;
  font-weight:600;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  cursor:pointer;
  transition:all 0.3s ease;
}
.btn-entry{ /* Bot√£o Entrada */
  background:var(--success);
  color:white;
  border:none;
}
.btn-entry:hover{
  background:#0d9488;
}
.btn-exit{ /* Bot√£o Sa√≠da */
  background:var(--danger);
  color:white;
  border:none;
}
.btn-exit:hover{
  background:#b91c1c;
}
.close-modal-btn-bottom{ /* Bot√£o Salvar e Fechar */
  margin-top:15px;
  padding:12px;
  border-radius:10px;
  font-size:0.9rem;
  font-weight:600;
  background:var(--primary); /* Cor mais neutra para salvar */
  color:white;
  border:none;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  cursor:pointer;
  transition:all 0.3s ease;
}
.close-modal-btn-bottom:hover{
  background:#1e293b;
}

.print-only{display:none;}
@media print{
  body{background:white;padding:0;}
.overlay{background:white;padding:0;}
.no-print{display:none!important;}
.print-only{display:block;}
.print-header{text-align:center;font-size:28px;font-weight:bold;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:20px;}
.grid{
    display:grid!important;
    grid-template-columns:repeat(6,1fr)!important; /* Mais colunas para PDF */
    gap:5px!important;
  }
.card{
    border:1px solid #eee!important;
    box-shadow:none!important;
    padding:5px!important;
    page-break-inside:avoid;
  }
.card img{height:70px!important; margin-bottom:5px!important;}
.card h3{font-size:0.55rem!important; line-height:1.1!important;}
.card p{font-size:0.6rem!important;}
.card p b{font-size:0.8rem!important;}
.badge-cat{font-size:0.5rem!important; padding:2px 6px!important; margin-top:2px!important;}
.admin-actions{display:none!important;}

.report-footer{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      border-top: 1px solid #000;
      padding: 5px 15mm;
      background: white;
      box-sizing: border-box;
      page-break-inside: avoid; /* Evita que o footer seja quebrado entre p√°ginas */
      page-break-before: avoid;
    }
.report-footer.datetime-info {
      flex-grow: 1;
      text-align: center;
      order: 2;
    }
.report-footer.count-info {
      flex-grow: 1;
      text-align: right;
      order: 3;
    }
.report-footer.flex-spacer-left {
      flex-grow: 1;
      order: 1;
    }

.hist-table th{font-weight:bold;}
}

/* Responsive adjustments */
@media (max-width: 1200px) {
.container-wrapper{
    flex-direction:column;
    gap:20px;
    margin:15px auto;
    padding:0 15px;
  }
.sidebar{
    width:100%;
    order:unset; /* Remover ordem para mobile */
    position: static; /* Remove o sticky em telas pequenas */
    max-height: none;
    overflow-y: visible;
  }
.main-content{
    order:unset;
  }
.header{
    flex-wrap:wrap;
    gap:15px;
    justify-content:center;
  }
.header h1{
    width:100%;
    text-align:center;
    justify-content:center;
  }
.search-container{
    order:3;
    width:100%;
    max-width:none;
  }
.nav-btns{
    order:2;
  }
  #adminPanel{
    grid-template-columns:1fr;
  }
.grid{
    grid-template-columns:repeat(auto-fill, minmax(140px, 1fr)); /* Ajuste para telas menores */
  }
}

@media (max-width: 768px) {
.header{
    padding:10px 15px;
  }
.header h1{
    font-size:1.5rem;
  }
.btn-primary,.btn-secondary{
    padding:8px 12px;
    font-size:0.8rem;
  }
.stats-bar{
    flex-direction:column;
    align-items:flex-start;
    gap:10px;
    padding:10px 15px;
  }
.stats-bar > div{
    flex-wrap:wrap;
    gap:15px;
  }
.backup-group{
    flex-wrap:wrap;
  }
.sidebar,.cat-filter-wrapper, #adminPanel, #historyPanel{
    padding:15px;
  }
.cat-filter{
    justify-content:center;
  }
.card{
    padding:10px;
    border-radius:10px;
  }
.card img{
    height:100px; /* Ainda menor em mobile */
  }
.card h3{
    font-size:0.8rem; /* Fonte ainda menor em mobile */
  }
.badge-cat{
    font-size:0.55rem; /* Fonte menor em mobile */
  }
.modal-content{
    width:90%;
    padding:20px;
  }
}
</style>
</head>
<body>
<div class="overlay">
  <div class="print-only print-header">üì¶ Relat√≥rio de Estoque Haris</div>
  <div class="container-wrapper">
    <!-- Left Sidebar -->
    <div class="sidebar left no-print">
      <div class="header" style="box-shadow:none; padding:0;">
        <h1><img src="https://cdn-icons-png.flaticon.com/512/3238/3238058.png" alt="Logo" style="height:30px;"> Haris <span>Estoque</span></h1>
      </div>

      <div class="cat-filter-wrapper">
        <h3>Filtrar por Categoria</h3>
        <div class="cat-filter" id="catFiltros"></div>
      </div>

      <!-- Imagem do rebocador adicionada aqui -->
      <div class="sidebar-image">
        <img id="sidebarImage" src="animao-de-um-rebocador-com-haris-escrito-na-inscri.jpeg" alt="Rebocador Haris"> 
      </div>

      <div class="input-group">
        <label for="inputBusca">Pesquisar Produto</label>
        <input type="text" id="inputBusca" class="search-input" placeholder="Nome do produto..." oninput="render()">
      </div>

      <!-- NOVO: Container para o select de ordena√ß√£o e o bot√£o de mudar imagem -->
      <div class="input-group" style="display:flex; flex-direction:column; gap:5px;">
        <label for="ordem">Ordenar Por</label>
        <div style="display:flex; align-items:center; gap:10px;">
          <select id="ordem" class="sort-select" style="flex:1;" onchange="render()">
            <option value="nome">A-Z</option>
            <option value="qtd-desc">Estoque ‚Üë</option>
            <option value="qtd-asc">Estoque ‚Üì</option>
          </select>
          <!-- Bot√£o para mudar imagem da sidebar -->
          <button class="btn-secondary" style="padding:8px 12px; font-size:0.75rem; white-space:nowrap;" onclick="document.getElementById('sidebarImageUploadHidden').click()">Mudar Imagem</button>
          <!-- Input type="file" escondido -->
          <input type="file" id="sidebarImageUploadHidden" accept="image/*" style="display:none;" onchange="uploadSidebarImage(event)">
        </div>
      </div>

      <div style="margin-top: auto; display:flex; flex-direction:column; gap:10px;">
        <button class="btn-secondary" id="btnAdmin" onclick="toggleAdmin()">üîë Admin</button>
        <button class="btn-primary" style="background:#1c74d0;" onclick="imprimirProdutos()">üìÑ Gerar PDF Produtos</button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <div class="stats-bar no-print">
        <div>
          <div>Produtos Cadastrados: <b id="totalProdutos">0</b></div>
          <div>Total em Estoque: <b id="totalEstoque">0</b></div>
        </div>
        <div class="backup-group" id="backupGroup">
          <button class="btn-secondary" onclick="toggleHistory()">üìã Hist√≥rico</button>
          <button class="btn-primary" style="background:#1c74d0;" onclick="exportarBackup()">üì• Exportar Backup</button>
          <button class="btn-secondary" onclick="document.getElementById('importInput').click()">üì§ Importar Backup</button>
          <input type="file" id="importInput" style="display:none" onchange="importarBackup(event)">
        </div>
      </div>

      <div id="adminPanel" class="no-print">
        <!-- IN√çCIO DA MELHORIA 5: Valida√ß√£o Visual - Adicionando div de erro -->
        <div class="input-group">
          <label>Nome do Produto</label>
          <input type="text" id="nome" placeholder="Ex: Tinta Branca 5L" required>
          <span class="error-message" id="error-nome">Este campo √© obrigat√≥rio.</span>
        </div>
        <div class="input-group">
          <label>Categoria</label>
          <select id="categoria"></select>
          <span class="error-message" id="error-categoria">Selecione uma categoria v√°lida.</span>
        </div>
        <div class="input-group">
          <label>Quantidade Inicial</label>
          <input type="number" id="qtd" value="0" min="0" required>
          <span class="error-message" id="error-qtd">A quantidade deve ser um n√∫mero maior ou igual a zero.</span>
        </div>
        <div class="input-group">
          <label>Foto do Produto</label>
          <input type="file" id="foto" accept="image/*" required>
          <span class="error-message" id="error-foto">Selecione uma imagem para o produto.</span>
        </div>
        <!-- FIM DA MELHORIA 5 -->
        <button class="btn-primary" style="align-self: flex-end;" onclick="cadastrar()">ADICIONAR PRODUTO</button>

        <!-- REMOVIDO: O campo de upload da imagem da sidebar foi movido para a sidebar principal -->
      </div>

      <div id="historyPanel" class="no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
          <h2>üìã Hist√≥rico de Movimenta√ß√µes</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn-primary" onclick="imprimirHistorico()">üìÑ PDF Hist√≥rico</button>
            <button class="btn-secondary" onclick="limparHistorico()">Limpar Hist√≥rico</button>
          </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
          <input type="text" id="inputBuscaHist" class="search-input" placeholder="Pesquisar produto ou motivo..." oninput="renderHistory()">
          <select id="filtroCatHist" class="sort-select" onchange="renderHistory()">
            <!-- Categorias s√£o geradas via JS em initDB() -->
          </select>
        </div>
        <div style="overflow-x:auto;">
          <table class="hist-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Produto</th>
                <th>Tipo</th>
                <th>Qtd</th>
                <th>Motivo</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="listaHist"></tbody>
          </table>
        </div>
      </div>

      <div class="grid" id="vitrine"></div>
    </div>
  </div>

  <!-- Rodap√© do PDF de produtos. Ser√° preenchido com JS -->
  <div class="print-only report-footer" id="productPrintFooter">
    <span class="flex-spacer-left"></span>
    <span class="datetime-info"></span>
    <span class="count-info"></span>
  </div>
</div>

<div id="modal" class="no-print">
  <div class="modal-content">
    <h2 class="modal-title">EDITAR PRODUTO</h2>
    <div class="input-group">
        <label for="mNomeEdit">Nome do Produto</label>
        <input type="text" id="mNomeEdit" disabled>
    </div>

    <div class="input-group">
        <label for="mCategoriaEdit">Categoria</label>
        <select id="mCategoriaEdit" disabled></select>
    </div>

    <div class="current-stock-display">
      <p>Estoque Atual</p>
      <b id="mQtd">0</b>
    </div>

    <!-- IN√çCIO DA MELHORIA 5: Valida√ß√£o Visual - Adicionando div de erro no modal -->
    <div class="input-group">
        <label for="valMov">Quantidade de Movimenta√ß√£o</label>
        <input type="number" id="valMov" value="0" min="0" required>
        <span class="error-message" id="error-valMov">A quantidade deve ser um n√∫mero maior ou igual a zero.</span>
    </div>

    <div class="input-group">
        <label for="mNota">Motivo da movimenta√ß√£o</label>
        <textarea id="mNota" placeholder="Motivo da movimenta√ß√£o..." required></textarea>
        <span class="error-message" id="error-mNota">O motivo da movimenta√ß√£o √© obrigat√≥rio.</span>
    </div>
    <!-- FIM DA MELHORIA 5 -->

    <div class="file-upload-group">
      <label for="mFoto">Alterar Foto:</label>
      <input type="file" id="mFoto" accept="image/*">
    </div>

    <div class="modal-actions">
      <button class="btn-entry" onclick="movimentar('add')">ENTRADA</button>
      <button class="btn-exit" onclick="movimentar('sub')">SA√çDA</button>
    </div>
    <button class="close-modal-btn-bottom" onclick="fecharModal()">SALVAR E FECHAR</button>
  </div>
</div>

<script>
let isAdmin = false, editIdx = null;
let db = [], historico = [];
let categoriasAtivas = []; // AGORA √â UM ARRAY DE CATEGORIAS SELECIONADAS!
let listaCategorias = ["Componente B", "Escova Rotativa", "Filtros", "Jotamastic A", "Jotamastic B", "Manilhas", "Pincel", "Rolo de Pintura", "Solvente", "Tinta Hardtop", "Tinta Pilot", "Outros"];

let sidebarImageUrl = ''; // Nova vari√°vel para guardar a Data URL da imagem da sidebar

// IN√çCIO DA MELHORIA 4: Cores de Categoria Din√¢micas
// Este objeto simularia as cores carregadas do IndexedDB.
// Em um sistema real, voc√™ teria uma interface para gerenciar isso e salvar no DB.
// As cores padr√£o est√£o aqui, mas seriam sobrescritas pelo que viesse do DB.
let coresCategoriasDb = new Map([
    ['Tinta Hardtop', '#f97316'],
    ['Tinta Pilot', '#3b82f6'],
    ['Componente B', '#14b8a6'],
    ['Jotamastic A', '#facc15'],
    ['Jotamastic B', '#8b5cf6'],
    ['Solvente', '#ef4444'],
    ['Filtros', '#a3e635'], 
    ['Manilhas', '#ec4899'],
    ['Escova Rotativa', '#FF8C00'], // Cor para a nova categoria
    ['Pincel', '#8A2BE2'], // Cor para a nova categoria
    ['Rolo de Pintura', '#00CED1'], // Cor para a nova categoria
    ['Outros', '#6b7280']
]);

// Fun√ß√£o para carregar as cores do IndexedDB
async function carregarCoresCategorias() {
    return new Promise((resolve, reject) => {
        const t = dbHaris.transaction('config', 'readonly');
        const store = t.objectStore('config');
        const request = store.get('category_colors');

        request.onsuccess = (e) => {
            const config = e.target.result;
            if (config && config.colors) {
                // Sobrescreve as cores padr√£o com as do DB
                for (const [key, value] of Object.entries(config.colors)) {
                    coresCategoriasDb.set(key, value);
                }
                console.log("Cores de categoria carregadas do IndexedDB.");
            } else {
                console.log("Nenhuma cor de categoria customizada encontrada no IndexedDB.");
            }
            resolve();
        };
        request.onerror = (e) => {
            console.error("Erro ao carregar cores de categoria do IndexedDB:", e);
            reject(e);
        };
    });
}

// Fun√ß√£o para salvar as cores no IndexedDB (seria chamada da sua interface de admin)
function salvarCoresCategorias() {
    const t = dbHaris.transaction('config', 'readwrite');
    const store = t.objectStore('config');
    const colorsObj = {};
    coresCategoriasDb.forEach((value, key) => { colorsObj[key] = value; });
    const request = store.put({ id: 'category_colors', colors: colorsObj });

    request.onsuccess = () => console.log("Cores de categoria salvas no IndexedDB.");
    request.onerror = (e) => console.error("Erro ao salvar cores de categoria no IndexedDB:", e);
}

// FIM DA MELHORIA 4

// Preenche os selects de categoria
function preencherSelectsDeCategoria() {
    const selects = document.querySelectorAll('#categoria, #filtroCatHist, #mCategoriaEdit');
    selects.forEach(select => {
        if (select.id === 'filtroCatHist') {
            select.innerHTML = '<option value="Todos">Todas as Categorias</option>';
        } else {
            select.innerHTML = ''; // Limpa antes de preencher
        }
        listaCategorias.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            select.appendChild(option);
        });
    });
}

// IndexedDB - FUN√á√ïES ATUALIZADAS
let dbHaris;
let dbReadyPromise; // NOVO: Uma Promise para controlar quando o DB est√° pronto

function initDB(){
  if (dbReadyPromise) return dbReadyPromise; // Se a Promise j√° existe, retorna ela

  dbReadyPromise = new Promise((resolve, reject) => {
    const request=indexedDB.open('db_haris',2); 
    request.onsuccess=async e=>{ // Adicionado 'async' aqui
      dbHaris=e.target.result; 
      await carregarCoresCategorias(); // IN√çCIO DA MELHORIA 4: Carrega cores antes de renderizar
      carregarDados();
      carregarSidebarImage(); 
      resolve(); // Resolve a Promise quando o DB est√° pronto
    }
    request.onerror=e=>{
      console.log("Erro IndexedDB:", e);
      reject(e); // Rejeita a Promise em caso de erro
    }
    request.onupgradeneeded=e=>{
      let dbe=e.target.result;
      if(!dbe.objectStoreNames.contains('produtos')) {
        dbe.createObjectStore('produtos',{keyPath:'id',autoIncrement:true});
      }
      if(!dbe.objectStoreNames.contains('historico')) {
        dbe.createObjectStore('historico',{keyPath:'id',autoIncrement:true});
      }
      if(!dbe.objectStoreNames.contains('config')) {
        dbe.createObjectStore('config', {keyPath: 'id'});
      }
    }
  });
  preencherSelectsDeCategoria();
  return dbReadyPromise; // Retorna a Promise
}

function carregarDados(){
  const t=dbHaris.transaction(['produtos','historico'],'readonly');
  t.objectStore('produtos').getAll().onsuccess=e=>{db=e.target.result; render();}
  t.objectStore('historico').getAll().onsuccess=e=>{historico=e.target.result; renderHistory();}
}
function salvarProdutos(){
  const t=dbHaris.transaction('produtos','readwrite');
  const store = t.objectStore('produtos');
  store.clear().onsuccess=()=>{
    db.forEach(p=> {
        const addRequest = store.add(p);
        addRequest.onerror = (event) => console.error("Erro ao adicionar produto:", event.target.error);
    });
  }
}
function salvarHistorico(){
  const t=dbHaris.transaction('historico','readwrite');
  const store=t.objectStore('historico'); store.clear().onsuccess=()=>{historico.forEach(h=>store.add(h));}
}

function carregarSidebarImage() {
  const t = dbHaris.transaction('config', 'readonly');
  const store = t.objectStore('config');
  const request = store.get('sidebar_image');

  request.onsuccess = (e) => {
    const config = e.target.result;
    const imgElement = document.getElementById('sidebarImage');

    if (config && config.imageUrl) {
      sidebarImageUrl = config.imageUrl;
      imgElement.src = sidebarImageUrl;
      console.log("Imagem da sidebar carregada do IndexedDB.");
    } else {
      const initialSrc = imgElement.getAttribute('src'); 
      if (initialSrc &&!initialSrc.startsWith('data:') &&!initialSrc.startsWith('http')) {
          imgElement.src = initialSrc; 
          console.log("Imagem da sidebar exibida via SRC do HTML (n√£o encontrada no IndexedDB). Clique em 'Mudar Imagem' para salv√°-la permanentemente.");
      } else {
          imgElement.src = 'https://via.placeholder.com/280x150?text=Imagem+Nao+Encontrada'; 
          console.warn("Imagem da sidebar n√£o encontrada no IndexedDB e SRC inicial inv√°lido ou ausente.");
      }
    }
  };
  request.onerror = (e) => console.error("Erro ao carregar imagem da sidebar do IndexedDB:", e);
}

function salvarSidebarImage(imageUrl) {
  const t = dbHaris.transaction('config', 'readwrite');
  const store = t.objectStore('config');
  const request = store.put({ id: 'sidebar_image', imageUrl: imageUrl });

  request.onsuccess = () => console.log("Imagem da sidebar salva no IndexedDB.");
  request.onerror = (e) => console.error("Erro ao salvar imagem da sidebar no IndexedDB:", e);
}

function uploadSidebarImage(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      sidebarImageUrl = e.target.result;
      document.getElementById('sidebarImage').src = sidebarImageUrl;
      salvarSidebarImage(sidebarImageUrl); 
      alert("Imagem da sidebar atualizada e salva!");
      event.target.value = null; 
    };
    reader.onerror = (e) => {
      console.error("Erro ao ler o arquivo de imagem para a sidebar:", e.target.error);
      alert("Erro ao ler o arquivo de imagem.");
    };
    reader.readAsDataURL(file);
  }
}

// Layout e fun√ß√µes
function toggleAdmin(){
  // A senha "RebocadorHaris"
  if(!isAdmin){if(prompt("Senha:")==="RebocadorHaris"){isAdmin=true;document.getElementById('adminPanel').style.display='grid';document.getElementById('backupGroup').style.display='flex';render();}}
  else{isAdmin=false;document.getElementById('adminPanel').style.display='none';document.getElementById('backupGroup').style.display='none';document.getElementById('historyPanel').style.display='none';render();}
}

function render(){
  const v=document.getElementById('vitrine');
  const termo=document.getElementById('inputBusca').value.toLowerCase();
  const fBox=document.getElementById('catFiltros');
  const ordem=document.getElementById('ordem').value;
  v.innerHTML='';
  
  // Renderiza os bot√µes de filtro de categoria
  // Inclui o bot√£o "Todos" e define se ele est√° ativo
  fBox.innerHTML = 
    `<button class="btn-cat ${categoriasAtivas.length === 0? 'active' : ''}" onclick="toggleCat('Todos')">Todos</button>` +
    listaCategorias.map(c => 
    `<button class="btn-cat ${categoriasAtivas.includes(c)? 'active' : ''}" onclick="toggleCat('${c}')">${c}</button>`
  ).join('');

  let cProd=0,cEst=0;

  let produtosExibidos = db.filter(p => {
    const matchesSearchTerm = p.nome.toLowerCase().includes(termo);
    // Se nenhuma categoria espec√≠fica est√° ativa, mostra todos. Caso contr√°rio, filtra pelas ativas.
    const matchesCategory = categoriasAtivas.length === 0 || categoriasAtivas.includes(p.cat);
    return matchesSearchTerm && matchesCategory;
  });

  if(ordem==='nome') produtosExibidos.sort((a,b)=>a.nome.localeCompare(b.nome));
  else if(ordem==='qtd-desc') produtosExibidos.sort((a,b)=>b.qtd-a.qtd);
  else if(ordem==='qtd-asc') produtosExibidos.sort((a,b)=>a.qtd-b.qtd);

  produtosExibidos.forEach(p=>{
    cProd++; cEst+=parseInt(p.qtd);
    v.innerHTML+=`
      <div class="card">
      <img src="${p.foto}">
      <div class="card-info">
        <h3>${p.nome}</h3>
        <span class="badge-cat" style="background:${getCorCat(p.cat)}">${p.cat||'Outros'}</span>
        <p>Estoque: <b>${p.qtd}</b></p>
        ${isAdmin?`<div class="admin-actions">
         <button class="btn-edit-card" onclick="abrirModal('${p.id}')">‚úèÔ∏è</button>
          <button class="btn-delete-card" onclick="deletarProduto('${p.id}')">üóëÔ∏è</button>
        </div>`:''}
      </div>
      </div>`;
  });
  document.getElementById('totalProdutos').innerText=cProd;
  document.getElementById('totalEstoque').innerText=cEst;
}

// FUN√á√ÉO ATUALIZADA PARA O COMPORTAMENTO DO FILTRO
function toggleCat(categoria){
  if (categoria === 'Todos') {
    categoriasAtivas = []; // Limpa todas as categorias
  } else {
    const index = categoriasAtivas.indexOf(categoria);
    if (index > -1) {
      categoriasAtivas.splice(index, 1); // Remove a categoria se j√° estiver ativa
    } else {
      categoriasAtivas.push(categoria); // Adiciona a categoria se n√£o estiver ativa
    }
  }
  render(); // Re-renderiza para aplicar o novo filtro
}

// IN√çCIO DA MELHORIA 4: Cores de Categoria Din√¢micas (usando o Map)
function getCorCat(cat){
  return coresCategoriasDb.get(cat) || '#6b7280'; // Retorna a cor do Map ou uma cor padr√£o
}
// FIM DA MELHORIA 4

// IN√çCIO DA MELHORIA 5: Valida√ß√£o Visual de Formul√°rios
function validateField(inputElement, errorMessageElement, validationFn) {
  const inputGroup = inputElement.closest('.input-group');
  if (validationFn(inputElement.value, inputElement.files)) {
    inputGroup.classList.remove('error');
    return true;
  } else {
    inputGroup.classList.add('error');
    errorMessageElement.textContent = inputElement.validationMessage || errorMessageElement.getAttribute('data-default-message') || 'Campo inv√°lido.';
    return false;
  }
}

function resetValidation(inputElement) {
  const inputGroup = inputElement.closest('.input-group');
  inputGroup.classList.remove('error');
}

// Adiciona listeners para resetar valida√ß√£o ao digitar/mudar
document.addEventListener('DOMContentLoaded', () => {
  const inputsToValidate = [
    {id: 'nome', msgId: 'error-nome', validate: val => val.trim()!== ''},
    {id: 'qtd', msgId: 'error-qtd', validate: val =>!isNaN(parseInt(val)) && parseInt(val) >= 0},
    {id: 'foto', msgId: 'error-foto', validate: (val, files) => files && files.length > 0},
    {id: 'valMov', msgId: 'error-valMov', validate: val =>!isNaN(parseInt(val)) && parseInt(val) > 0},
    {id: 'mNota', msgId: 'error-mNota', validate: val => val.trim()!== ''},
  ];

  inputsToValidate.forEach(item => {
    const input = document.getElementById(item.id);
    const errorMsg = document.getElementById(item.msgId);
    if (input && errorMsg) {
      // Guarda a mensagem padr√£o para o caso de n√£o ter validationMessage
      errorMsg.setAttribute('data-default-message', errorMsg.textContent);
      input.addEventListener('input', () => resetValidation(input));
      input.addEventListener('change', () => resetValidation(input)); // Para inputs type="file"
    }
  });
});

// FIM DA MELHORIA 5

function cadastrar(){
  const nInput = document.getElementById('nome');
  const cSelect = document.getElementById('categoria');
  const qInput = document.getElementById('qtd');
  const fInput = document.getElementById('foto');

  // IN√çCIO DA MELHORIA 5: Valida√ß√£o Visual
  let isValid = true;
  isValid = validateField(nInput, document.getElementById('error-nome'), val => val.trim()!== '') && isValid;
  // Para select, podemos considerar que qualquer op√ß√£o que n√£o seja vazia (se houver) √© v√°lida.
  // Por simplicidade, vamos considerar que sempre ter√° uma categoria selecionada ap√≥s initDB.
  // Se quiser validar para que n√£o seja 'Selecione uma categoria...', precisa de uma op√ß√£o default.
  // isValid = validateField(cSelect, document.getElementById('error-categoria'), val => val.trim()!== '') && isValid;
  isValid = validateField(qInput, document.getElementById('error-qtd'), val =>!isNaN(parseInt(val)) && parseInt(val) >= 0) && isValid;
  isValid = validateField(fInput, document.getElementById('error-foto'), (val, files) => files && files.length > 0) && isValid;

  if (!isValid) {
    return; // Impede o cadastro se a valida√ß√£o falhar
  }
  // FIM DA MELHORIA 5

  const n=nInput.value;
  const c=cSelect.value;
  const q=parseInt(qInput.value); 
  const f=fInput.files[0];
  
  const reader=new FileReader();
  reader.onload=e=>{
    const novoProduto = {nome:n,cat:c,qtd:q,foto:e.target.result};
    const transaction = dbHaris.transaction('produtos', 'readwrite');
    const store = transaction.objectStore('produtos');
    const addRequest = store.add(novoProduto);

    addRequest.onsuccess = (event) => {
        novoProduto.id = event.target.result;
        db.push(novoProduto); 
        salvarProdutos();
        render();
        // Limpa campos e resetta valida√ß√£o
        nInput.value=''; resetValidation(nInput);
        qInput.value='0'; resetValidation(qInput);
        fInput.value=''; resetValidation(fInput);
    };
    addRequest.onerror = (event) => {
        console.error("Erro ao cadastrar produto no IndexedDB:", event.target.error);
        alert("Erro ao cadastrar produto.");
    };
  }
  reader.readAsDataURL(f);
}

function abrirModal(productId){
  const p = db.find(prod => prod.id == productId);
  if (!p) {
    alert("Produto n√£o encontrado para edi√ß√£o.");
    return;
  }
  editIdx = db.indexOf(p);
  document.getElementById('mNomeEdit').value=p.nome;
  document.getElementById('mQtd').innerText=p.qtd;
  document.getElementById('mNota').value='';
  document.getElementById('valMov').value='0'; // Reset para 0
  document.getElementById('mCategoriaEdit').value=p.cat; 
  document.getElementById('mFoto').value = '';

  // IN√çCIO DA MELHORIA 5: Reseta valida√ß√£o ao abrir modal
  resetValidation(document.getElementById('valMov'));
  resetValidation(document.getElementById('mNota'));
  // FIM DA MELHORIA 5

  document.getElementById('modal').style.display='flex';
}
function fecharModal(){
  const p=db[editIdx];
  // O nome e a categoria no modal est√£o desabilitados, ent√£o n√£o precisam ser lidos de volta.
  // p.nome=document.getElementById('mNomeEdit').value;
  // p.cat=document.getElementById('mCategoriaEdit').value; 
  
  const f=document.getElementById('mFoto').files[0];
  if(f){
    const r=new FileReader();
    r.onload=e=>{p.foto=e.target.result; salvarProdutos(); render();}
    r.readAsDataURL(f);
  } else {
    salvarProdutos(); render();
  }
  document.getElementById('modal').style.display='none';
  document.getElementById('mFoto').value = ''; 
}

function movimentar(tipo){
  const valMovInput = document.getElementById('valMov');
  const mNotaInput = document.getElementById('mNota');

  // IN√çCIO DA MELHORIA 5: Valida√ß√£o Visual no modal
  let isValid = true;
  isValid = validateField(valMovInput, document.getElementById('error-valMov'), val =>!isNaN(parseInt(val)) && parseInt(val) > 0) && isValid;
  isValid = validateField(mNotaInput, document.getElementById('error-mNota'), val => val.trim()!== '') && isValid;

  if (!isValid) {
    return; // Impede a movimenta√ß√£o se a valida√ß√£o falhar
  }
  // FIM DA MELHORIA 5

  const val=parseInt(valMovInput.value);
  const nota=mNotaInput.value;
  const p=db[editIdx];
  let tipoMov = '';

  if(tipo==='add') {
    p.qtd+=val;
    tipoMov = 'Entrada';
  }
  else if(tipo==='sub') {
    if(p.qtd < val){ 
        // IN√çCIO DA MELHORIA 5: Mensagem de erro espec√≠fica para estoque insuficiente
        valMovInput.closest('.input-group').classList.add('error');
        document.getElementById('error-valMov').textContent = `Estoque insuficiente! M√°ximo ${p.qtd}.`;
        return;
        // FIM DA MELHORIA 5
    }
    p.qtd-=val;
    tipoMov = 'Sa√≠da';
  }

  historico.push({data:new Date().toLocaleString(),produto:p.nome,cat:p.cat,tipo:tipoMov,qtd:val,motivo:nota});
  salvarProdutos(); salvarHistorico(); render(); renderHistory();
  document.getElementById('mQtd').innerText=p.qtd;
  valMovInput.value='0'; resetValidation(valMovInput);
  mNotaInput.value=''; resetValidation(mNotaInput);
}

function deletarProduto(productId){
  if(confirm('Deseja deletar este produto?')){
    const indexToDelete = db.findIndex(p => p.id == productId);
    if (indexToDelete > -1) {
      db.splice(indexToDelete, 1);
      salvarProdutos();
      render();
    } else {
      alert("Produto n√£o encontrado para exclus√£o.");
    }
  }
}

function toggleHistory(){
  const historyPanel = document.getElementById('historyPanel');
  historyPanel.style.display = historyPanel.style.display === 'none' || historyPanel.style.display === ''? 'block' : 'none';
  renderHistory();
}
function limparHistorico(){if(confirm('Deseja limpar todo o hist√≥rico?')){historico=[]; salvarHistorico(); renderHistory();}}

function renderHistory(){
  const termo=document.getElementById('inputBuscaHist').value.toLowerCase();
  const filtro=document.getElementById('filtroCatHist').value;
  const tbody=document.getElementById('listaHist');
  tbody.innerHTML='';
  let totalMovimentacoes = 0;

  const historicoOrdenado = [...historico].reverse();

  historicoOrdenado.forEach((h,i)=>{
    if((h.produto.toLowerCase().includes(termo)||h.motivo.toLowerCase().includes(termo))&&(filtro==='Todos'||h.cat===filtro)){
      totalMovimentacoes++;
      let tipoDisplay = h.tipo === 'Entrada'? `<span class="tag-add">${h.tipo}</span>` : `<span class="tag-sub">${h.tipo}</span>`;
      tbody.innerHTML+=`
      <tr>
        <td>${h.data}</td>
        <td>${h.produto}</td>
        <td>${tipoDisplay}</td>
        <td>${h.qtd}</td>
        <td>${h.motivo}</td>
        <td><button class="lixeira" onclick="deletarHist(${historico.length - 1 - i})">üóëÔ∏è</button></td>
      </tr>`;
    }
  });

  if (totalMovimentacoes === 0) {
      tbody.innerHTML += `<tr><td colspan="6" style="text-align:center; color:var(--subtle-text);">Nenhuma movimenta√ß√£o encontrada.</td></tr>`;
  }
}

function deletarHist(idx){historico.splice(idx,1); salvarHistorico(); renderHistory();}

function exportarBackup(){
  const data = {
    produtos: db,
    historico: historico,
    sidebarImage: sidebarImageUrl,
    categoryColors: Object.fromEntries(coresCategoriasDb) // IN√çCIO DA MELHORIA 4: Exporta cores tamb√©m
  };
  const jsonString = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonString], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "haris_estoque_backup.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importarBackup(event){
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        if (importedData.produtos && importedData.historico) {
          // Garante que o IndexedDB est√° pronto antes de tentar usar 'dbHaris'
          initDB().then(() => { // Espera o DB estar pronto
            if (confirm("Importar backup? Isso substituir√° os dados atuais.")) {
              db = importedData.produtos;
              historico = importedData.historico;
              
              if (importedData.sidebarImage) {
                sidebarImageUrl = importedData.sidebarImage;
                document.getElementById('sidebarImage').src = sidebarImageUrl;
                salvarSidebarImage(sidebarImageUrl); // Salva no IndexedDB
              }

              // IN√çCIO DA MELHORIA 4: Importa e salva as cores das categorias
              if (importedData.categoryColors) {
                coresCategoriasDb.clear(); // Limpa as cores atuais
                for (const [key, value] of Object.entries(importedData.categoryColors)) {
                    coresCategoriasDb.set(key, value);
                }
                salvarCoresCategorias(); // Salva as cores importadas no IndexedDB
              }
              // FIM DA MELHORIA 4

              salvarProdutos();
              salvarHistorico();
              render();
              renderHistory();
              alert("Backup importado com sucesso!");
            }
          }).catch(error => {
            console.error("Erro ao inicializar o IndexedDB para importar backup:", error);
            alert("Erro ao inicializar o banco de dados para importar o backup.");
          });
        } else {
          alert("Arquivo de backup inv√°lido. Estrutura incorreta.");
        }
      } catch (error) {
        alert("Erro ao ler o arquivo de backup: " + error.message);
      }
    };
    reader.readAsText(file);
  }
}

function imprimirProdutos(){
  window.onbeforeprint = () => {
    const printFooter = document.getElementById('productPrintFooter');
    const currentDateTime = new Date().toLocaleString();
    const totalProductsCount = db.length;

    printFooter.querySelector('.datetime-info').textContent = `Data de Emiss√£o: ${currentDateTime}`;
    printFooter.querySelector('.count-info').textContent = `QTD Produtos: ${totalProductsCount}`;
  };

  window.print();

  window.onafterprint = () => {
    const printFooter = document.getElementById('productPrintFooter');
    printFooter.querySelector('.datetime-info').textContent = '';
    printFooter.querySelector('.count-info').textContent = '';
  };
}

function imprimirHistorico(){
  let novaJan=window.open('','_blank');
  let currentDateTime = new Date().toLocaleString();

  let html=`<html><head><title>Hist√≥rico de Movimenta√ß√µes</title><style>
    body{font-family:'Poppins', sans-serif;padding:0; margin: 0; min-height: 100vh; display: flex; flex-direction: column;}
.content-wrapper { flex-grow: 1; padding: 15mm; }
    h1{text-align:center;font-size:24px;font-weight:bold;margin-bottom:20px; color:#1f2a40;}
    table{width:100%;border-collapse:collapse;font-size:12px; margin-top: 15px;}
    th,td{padding:8px;border:1px solid #e0e7ee;text-align:left; page-break-inside: avoid;}
    th{font-weight:600; background-color: #f0f4f8; color:#334155;}
    tr:nth-child(even){background-color:#f9fbfc!important;}
    tr:nth-child(odd){background-color:#ffffff!important;}
    table tbody tr { page-break-inside: avoid; page-break-after: auto;}
.tag-add{color:#10b8a6;font-weight:bold;} 
.tag-sub{color:#ef4444;font-weight:bold;}

.report-footer{
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        border-top: 1px solid #000;
        padding: 5mm 15mm;
        background: white;
        box-sizing: border-box;
        page-break-before: avoid;
      }
.report-footer.datetime-info { flex-grow: 1; text-align: center; order: 2; }
.report-footer.count-info { flex-grow: 1; text-align: right; order: 3; }
.report-footer.flex-spacer-left { flex-grow: 1; order: 1; }

    @page { margin: 15mm; }
    table th:nth-child(1), table td:nth-child(1) { width: 18%; }
    table th:nth-child(2), table td:nth-child(2) { width: 30%; }
    table th:nth-child(3), table td:nth-child(3) { width: 12%; }
    table th:nth-child(4) { width: 8%; }
    table td:nth-child(4) { width: 8%; text-align: center; }
    table th:nth-child(5), table td:nth-child(5) { width: 32%; }
  </style></head><body>`;

  html+=`<div class="content-wrapper"><h1>Hist√≥rico de Movimenta√ß√µes Haris</h1><table><thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Motivo</th></tr></thead><tbody>`;

  let totalMovimentacoesImpressao = 0;
  const termo=document.getElementById('inputBuscaHist').value.toLowerCase();
  const filtro=document.getElementById('filtroCatHist').value;
  const historicoParaImprimir = historico.filter(h =>
      (h.produto.toLowerCase().includes(termo)||h.motivo.toLowerCase().includes(termo)) &&
      (filtro==='Todos'||h.cat===filtro)
  ).reverse();

  historicoParaImprimir.forEach(h=>{
    totalMovimentacoesImpressao++;
    let tipoDisplay = h.tipo === 'Entrada'? `<span class="tag-add">${h.tipo}</span>` : `<span class="tag-sub">${h.tipo}</span>`;
    html+=`<tr><td>${h.data}</td><td>${h.produto}</td><td>${tipoDisplay}</td><td>${h.qtd}</td><td>${h.motivo}</td></tr>`;
  });

  if (totalMovimentacoesImpressao === 0) {
      html += `<tr><td colspan="5" style="text-align:center; color:#64748b;">Nenhuma movimenta√ß√£o encontrada para o filtro atual.</td></tr>`;
  }

  html+=`</tbody></table></div>`;
  html+=`<div class="report-footer">
    <span class="flex-spacer-left"></span>
    <span class="datetime-info">Data de Emiss√£o: ${currentDateTime}</span>
    <span class="count-info">QTD Movimenta√ß√µes: ${totalMovimentacoesImpressao}</span>
  </div></body></html>`;

  novaJan.document.write(html);
  novaJan.document.close();

  novaJan.print();

  setTimeout(() => {
    novaJan.close();
  }, 100);
}

// Inicializa√ß√£o
initDB();
</script>
</body>
</html>
