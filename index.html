<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Estoque Haris</title>
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="https://cdn-icons-png.flaticon.com">
<style>
:root{
  --primary:#1e293b;
  --accent:#2563eb;
  --success:#10b981;
  --danger:#e11d48;
  --bg:#f1f5f9;
}
body{margin:0;padding:15px;font-family:sans-serif;background:var(--bg);color:var(--primary);}
.container{max-width:1400px;margin:auto;}
.header{display:flex;justify-content:space-between;align-items:center;background:white;padding:15px 20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.03);}
.search-container{flex:1;display:flex;gap:8px;align-items:center;}
.search-input{flex:1;padding:10px;border-radius:8px;border:1px solid #e2e8f0;font-size:0.85rem;}
.sort-select{width:110px;padding:9px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;font-size:0.75rem;}
.nav-btns{display:flex;gap:5px;}
.btn-cat{padding:10px 18px;border-radius:30px;border:none;background:white;cursor:pointer;font-size:0.8rem;transition:0.3s;box-shadow:0 2px 5px rgba(0,0,0,0.05);}
.btn-cat.active{background:var(--accent);color:white;}
.cat-filter{display:flex;gap:5px;margin-bottom:15px;flex-wrap:wrap;}
#adminPanel{display:none;background:white;padding:15px;border-radius:12px;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:10px;margin-bottom:15px;align-items:end;border-left:5px solid var(--accent);}
.input-group label{font-size:0.65rem;font-weight:700;color:#64748b;margin-bottom:3px;display:block;}
input,select,textarea{padding:8px;border:1px solid #e2e8f0;border-radius:8px;width:100%;box-sizing:border-box;font-size:0.8rem;}
.stats-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;background:white;padding:10px 15px;border-radius:10px;border:1px solid #e2e8f0;font-size:0.8rem;}
.backup-group{display:none;gap:5px;}
#historyPanel{display:none;background:white;padding:25px;border-radius:16px;margin-bottom:30px;border-left:5px solid var(--primary);box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.hist-table{width:100%;border-collapse:collapse;margin-top:15px;font-size:0.85rem;}
.hist-table th,.hist-table td{padding:12px;text-align:left;border-bottom:1px solid #eee;}
.hist-table tr:nth-child(even){background:#f5f5f5;}
.hist-table input{font-weight:bold;font-family:sans-serif;}
.tag-add{color:var(--success);font-weight:bold;}
.tag-sub{color:var(--danger);font-weight:bold;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;}
.card{background:white;border-radius:12px;overflow:hidden;border:1px solid #e2e8f0;text-align:center;transition:0.3s;padding:10px;break-inside:avoid;position:relative;}
.card img{width:100%;height:130px;object-fit:contain;background:#f9faf9;border-radius:8px;}
.card-info{padding:8px 0;display:flex;flex-direction:column;align-items:center;}
.badge-cat{font-size:0.55rem;padding:3px 8px;border-radius:5px;color:white;font-weight:bold;text-transform:uppercase;margin-top:4px;}
.admin-actions{display:flex;flex-direction:row;justify-content:center;gap:6px;margin-top:6px;}
.btn-edit-card,.btn-delete-card{font-size:0.65rem;padding:4px 6px;background:#f8fafc;border:1px solid #ddd;border-radius:5px;cursor:pointer;}
.btn-delete-card{background:#fef2f2;border-color:#fca5a5;color:#b91c1c;}
#modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background: rgba(15,23,42,0.8);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.modal-content{background:white;padding:25px;border-radius:20px;width:320px;text-align:center;}
.lixeira{background:#fef2f2;border:none;border-radius:5px;color:#b91c1c;font-size:1rem;cursor:pointer;padding:3px 6px;transition:0.2s;}
.lixeira:hover{background:#b91c1c;color:white;}
.print-only{display:none;}
@media print{
  body{background:white;padding:0; counter-reset: page;}
 .no-print{display:none!important;}
 .print-only{display:block;}
 .print-header{text-align:center;font-size:28px;font-weight:bold;border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:20px;}
  /* Ajustes para o grid no PDF de produtos */
 .grid{display:grid!important;grid-template-columns:repeat(6,1fr)!important;gap:5px!important;}
 .card{border:1px solid #eee!important;box-shadow:none!important;padding:5px!important;page-break-inside:avoid;}
 .card img{height:80px!important;}
 .card h3{font-size:0.6rem!important;}
 .admin-actions{display:none!important;}
  /* Rodap√© e contador de p√°gina para PDF de produtos */
 .footer-print{position:fixed;bottom:0;width:100%;display:flex;justify-content:center;font-size:10px;border-top:1px solid #ddd;padding-top:5px;background:white;}
 .page-counter{position:fixed;bottom:0;right:15px;font-size:10px;padding-top:5px;}
 .hist-table th{font-weight:bold;}
}
</style>
</head>
<body>
<div class="container">
  <div class="print-only print-header">üì¶ Relat√≥rio de Estoque Haris</div>
  <div class="no-print">
    <div class="header">
      <h1>üì¶ Haris</h1>
      <div class="search-container">
        <input type="text" id="inputBusca" class="search-input" placeholder="Pesquisar..." oninput="render()">
        <select id="ordem" class="sort-select" onchange="render()">
          <option value="nome">A-Z</option>
          <option value="qtd-desc">Estoque ‚Üë</option>
          <option value="qtd-asc">Estoque ‚Üì</option>
        </select>
      </div>
      <div class="nav-btns">
        <button class="btn-cat" id="btnAdmin" onclick="toggleAdmin()">üîë Admin</button>
        <button class="btn-cat" onclick="imprimirProdutos()" style="background:var(--primary);color:white;">üìÑ PDF</button>
      </div>
    </div>

    <div class="stats-bar">
      <div style="display:flex; gap:15px;">
        <div>Produtos: <b id="totalProdutos">0</b></div>
        <div>Total Unid: <b id="totalEstoque">0</b></div>
      </div>
      <div class="backup-group" id="backupGroup" style="display:none; gap:5px;">
        <button class="btn-cat" style="background:#2563eb;color:white;" onclick="toggleHistory()">üìã Hist√≥rico</button>
        <button class="btn-cat" onclick="exportarBackup()">üì• Exportar</button>
        <button class="btn-cat" onclick="document.getElementById('importInput').click()">üì§ Importar</button>
        <input type="file" id="importInput" style="display:none" onchange="importarBackup(this)">
      </div>
    </div>

    <div id="historyPanel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="margin:0; font-size:1.1rem;">üìã Hist√≥rico</h2>
        <div style="display:flex; gap:5px;">
          <button class="btn-cat" style="background:#2563eb;color:white;" onclick="imprimirHistorico()">üìÑ PDF Hist√≥rico</button>
          <button class="btn-cat" onclick="limparHistorico()">Limpar Tudo</button>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-bottom:15px;">
        <input type="text" id="inputBuscaHist" class="search-input" placeholder="Pesquisar produto ou motivo..." oninput="renderHistory()">
        <select id="filtroCatHist" class="sort-select" onchange="renderHistory()">
          <option value="Todos">Todas as Categorias</option>
          <option value="Tinta Hardtop">Tinta Hardtop</option>
          <option value="Tinta Pilot">Tinta Pilot</option>
          <option value="Componente B">Componente B</option>
          <option value="Jotamastic A">Jotamastic A</option>
          <option value="Jotamastic B">Jotamastic B</option>
          <option value="Solvente">Solvente</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      <table class="hist-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Produto</th>
            <th>Tipo</th>
            <th>Qtd</th>
            <th>Motivo</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="listaHist"></tbody>
      </table>
    </div>

    <div class="cat-filter" id="catFiltros"></div>
    <div id="adminPanel">
      <div class="input-group"><label>Nome</label><input type="text" id="nome"></div>
      <div class="input-group"><label>Categoria</label>
        <select id="categoria">
          <option value="Tinta Hardtop">Tinta Hardtop</option>
          <option value="Tinta Pilot">Tinta Pilot</option>
          <option value="Componente B">Componente B</option>
          <option value="Jotamastic A">Jotamastic A</option>
          <option value="Jotamastic B">Jotamastic B</option>
          <option value="Solvente">Solvente</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      <div class="input-group"><label>Qtd</label><input type="number" id="qtd"></div>
      <div class="input-group"><label>Foto</label><input type="file" id="foto" accept="image/*"></div>
      <button class="btn-cat" style="background:var(--accent);color:white;height:35px;" onclick="cadastrar()">CADASTRAR</button>
    </div>
  </div>

  <div class="grid" id="vitrine"></div>
  <!-- Rodap√© e contador de p√°gina para PDF de produtos -->
  <div class="print-only footer-print" id="printDateTime"></div>
  <div class="print-only page-counter">P√°gina <span class="pageNumber"></span></div>
</div>

<div id="modal" class="no-print">
  <div class="modal-content">
    <p style="font-size:0.7rem; font-weight:bold; margin-bottom:5px;">EDITAR PRODUTO</p>
    <input type="text" id="mNomeEdit" style="margin-bottom:10px; font-weight:bold; text-align:center;">
    <div style="background:#f8fafc; padding:8px; border-radius:8px; margin-bottom:10px;">
      <p style="margin:0; font-size:0.6rem;">Estoque Atual</p>
      <b id="mQtd" style="font-size:1.5rem;">0</b>
    </div>
    <input type="number" id="valMov" value="0" style="text-align:center; width:60px; margin:auto;">
    <textarea id="mNota" placeholder="Motivo..." style="margin-top:8px; height:40px; font-size:0.7rem;"></textarea>
    <div style="margin-top:8px;">
      <label>Alterar Foto:</label>
      <input type="file" id="mFoto" accept="image/*">
    </div>
    <div style="display:flex; gap:8px; margin-top:12px;">
      <button class="btn-cat" style="background:var(--success); color:white; flex:1;" onclick="movimentar('add')">ENTRADA</button>
      <button class="btn-cat" style="background:var(--danger); color:white; flex:1;" onclick="movimentar('sub')">SA√çDA</button>
    </div>
    <button onclick="fecharModal()" style="margin-top:15px; cursor:pointer; background:none; border:none; text-decoration:underline; font-size:0.7rem;">SALVAR E FECHAR</button>
  </div>
</div>

<script>
let isAdmin=false,editIdx=null;
let db=[], historico=[];
let catAtiva='Todos';
let listaCategorias=["Tinta Hardtop","Tinta Pilot","Componente B","Jotamastic A","Jotamastic B","Solvente","Outros"];

// IndexedDB
let dbHaris;
function initDB(){
  const request=indexedDB.open('db_haris',1);
  request.onsuccess=e=>{dbHaris=e.target.result; carregarDados();}
  request.onerror=e=>console.log(e);
  request.onupgradeneeded=e=>{
    let dbe=e.target.result;
    if(!dbe.objectStoreNames.contains('produtos')) dbe.createObjectStore('produtos',{keyPath:'id',autoIncrement:true});
    if(!dbe.objectStoreNames.contains('historico')) dbe.createObjectStore('historico',{keyPath:'id',autoIncrement:true});
  }
}
function carregarDados(){
  const t=dbHaris.transaction(['produtos','historico'],'readonly');
  t.objectStore('produtos').getAll().onsuccess=e=>{db=e.target.result; render();}
  t.objectStore('historico').getAll().onsuccess=e=>{historico=e.target.result; renderHistory();}
}
function salvarProdutos(){
  const t=dbHaris.transaction('produtos','readwrite');
  const store=t.objectStore('produtos'); store.clear().onsuccess=()=>{db.forEach(p=>store.add(p));}
}
function salvarHistorico(){
  const t=dbHaris.transaction('historico','readwrite');
  const store=t.objectStore('historico'); store.clear().onsuccess=()=>{historico.forEach(h=>store.add(h));}
}

// Layout e fun√ß√µes
function toggleAdmin(){
  if(!isAdmin){if(prompt("Senha:")==="RebocadorHaris"){isAdmin=true;document.getElementById('adminPanel').style.display='grid';document.getElementById('backupGroup').style.display='flex';render();}}
  else{isAdmin=false;document.getElementById('adminPanel').style.display='none';document.getElementById('backupGroup').style.display='none';document.getElementById('historyPanel').style.display='none';render();}
}

function render(){
  const v=document.getElementById('vitrine');
  const termo=document.getElementById('inputBusca').value.toLowerCase();
  const fBox=document.getElementById('catFiltros');
  const ordem=document.getElementById('ordem').value;
  v.innerHTML=''; fBox.innerHTML=['Todos',...listaCategorias].map(c=>`<button class="btn-cat ${catAtiva===c?'active':''}" onclick="setCat('${c}')">${c}</button>`).join('');
  let cProd=0,cEst=0;
  let copia=[...db];
  if(ordem==='nome') copia.sort((a,b)=>a.nome.localeCompare(b.nome));
  else if(ordem==='qtd-desc') copia.sort((a,b)=>b.qtd-a.qtd);
  else if(ordem==='qtd-asc') copia.sort((a,b)=>a.qtd-b.qtd);

  copia.forEach((p,i)=>{
    if(p.nome.toLowerCase().includes(termo)&&(catAtiva==='Todos'||p.cat===catAtiva)){
      cProd++; cEst+=parseInt(p.qtd);
      v.innerHTML+=`
      <div class="card">
      <img src="${p.foto}">
      <div class="card-info">
        <h3 style="margin:2px 0; font-size:0.75rem; line-height:1.1;">${p.nome}</h3>
        <span class="badge-cat" style="background:${getCorCat(p.cat)}">${p.cat||'Outros'}</span>
        <p style="margin:0; font-size:0.7rem; color:gray;">Estoque: <b style="font-size:0.9rem;">${p.qtd}</b></p>
        ${isAdmin?`<div class="admin-actions">
          <button class="btn-edit-card" onclick="abrirModal(${i})">‚úèÔ∏è</button>
          <button class="btn-delete-card" onclick="deletarProduto(${i})">üóëÔ∏è</button>
        </div>`:''}
      </div>
      </div>`;
    }
  });
  document.getElementById('totalProdutos').innerText=cProd;
  document.getElementById('totalEstoque').innerText=cEst;
}

function setCat(c){catAtiva=c; render();}

function getCorCat(cat){
  const cores={'Tinta Hardtop':'#f97316','Tinta Pilot':'#3b82f6','Componente B':'#14b8a6','Jotamastic A':'#facc15','Jotamastic B':'#8b5cf6','Solvente':'#ef4444','Outros':'#6b7280'};
  return cores[cat]||'#6b7280';
}

// Cadastro
function cadastrar(){
  const n=document.getElementById('nome').value;
  const c=document.getElementById('categoria').value;
  const q=document.getElementById('qtd').value;
  const f=document.getElementById('foto').files[0];
  if(!n||!q||!f)return alert('Preencha todos os campos!');
  const reader=new FileReader();
  reader.onload=e=>{
    db.push({nome:n,cat:c,qtd:parseInt(q),foto:e.target.result});
    salvarProdutos(); render();
    document.getElementById('nome').value='';document.getElementById('qtd').value='';document.getElementById('foto').value='';
  }
  reader.readAsDataURL(f);
}

// Modal edi√ß√£o
function abrirModal(idx){
  editIdx=idx;
  const p=db[idx];
  document.getElementById('mNomeEdit').value=p.nome;
  document.getElementById('mQtd').innerText=p.qtd;
  document.getElementById('mNota').value='';
  document.getElementById('valMov').value=0;
  document.getElementById('modal').style.display='flex';
}
function fecharModal(){
  const p=db[editIdx];
  p.nome=document.getElementById('mNomeEdit').value;
  const f=document.getElementById('mFoto').files[0];
  if(f){
    const r=new FileReader();
    r.onload=e=>{p.foto=e.target.result; salvarProdutos(); render();}
    r.readAsDataURL(f);
  }
  salvarProdutos(); render(); document.getElementById('modal').style.display='none';
}

// Movimenta√ß√£o
function movimentar(tipo){
  const val=parseInt(document.getElementById('valMov').value)||0;
  if(val<=0) return alert('Informe uma quantidade v√°lida!');
  const nota=document.getElementById('mNota').value||'-';
  const p=db[editIdx];
  if(tipo==='add') p.qtd+=val;
  else if(tipo==='sub') p.qtd-=val;
  if(p.qtd<0)p.qtd=0;
  historico.push({data:new Date().toLocaleString(),produto:p.nome,cat:p.cat,tipo:tipo==='add'?'Entrada':'Sa√≠da',qtd:val,motivo:nota});
  salvarProdutos(); salvarHistorico(); render(); renderHistory();
  document.getElementById('mQtd').innerText=p.qtd;
  document.getElementById('valMov').value=0;document.getElementById('mNota').value='';
}

// Deletar produto
function deletarProduto(idx){
  if(confirm('Deseja deletar este produto?')){db.splice(idx,1); salvarProdutos(); render();}
}

// Hist√≥rico
function toggleHistory(){document.getElementById('historyPanel').style.display=document.getElementById('historyPanel').style.display==='none'?'block':'none'; renderHistory();}
function limparHistorico(){if(confirm('Deseja limpar todo o hist√≥rico?')){historico=[]; salvarHistorico(); renderHistory();}}

function renderHistory(){
  const termo=document.getElementById('inputBuscaHist').value.toLowerCase();
  const filtro=document.getElementById('filtroCatHist').value;
  const tbody=document.getElementById('listaHist');
  tbody.innerHTML='';
  let totalMovimentacoes = 0; // Para contar o total de movimenta√ß√µes exibidas

  historico.forEach((h,i)=>{
    if((h.produto.toLowerCase().includes(termo)||h.motivo.toLowerCase().includes(termo))&&(filtro==='Todos'||h.cat===filtro)){
      totalMovimentacoes++; // Incrementa o contador
      tbody.innerHTML+=`
      <tr>
        <td>${h.data}</td>
        <td>${h.produto}</td>
        <td>${h.tipo}</td>
        <td>${h.qtd}</td>
        <td>${h.motivo}</td>
        <td><button class="lixeira" onclick="deletarHist(${i})">üóëÔ∏è</button></td>
      </tr>`;
    }
  });

  // Adiciona uma linha de total ou mensagem se n√£o houver resultados
  if (totalMovimentacoes === 0) {
      tbody.innerHTML += `<tr><td colspan="6" style="text-align:center;">Nenhuma movimenta√ß√£o encontrada.</td></tr>`;
  } else {
      // Opcional: Adicionar um rodap√© com o total de itens na tabela do hist√≥rico, se desejar.
      // Por enquanto, vou deixar sem um total vis√≠vel na tabela da interface, apenas para a impress√£o.
  }
}

function deletarHist(idx){historico.splice(idx,1); salvarHistorico(); renderHistory();}

// PDF Produtos
function imprimirProdutos(){
  // Garante que o contador de p√°ginas do navegador funcione
  window.onbeforeprint = () => {
    const pageCounters = document.querySelectorAll('.page-counter.pageNumber');
    pageCounters.forEach((counter, index) => {
      // Esta parte √© mais complexa de controlar com window.print() para cada p√°gina,
      // geralmente o pr√≥prio navegador injeta a numera√ß√£o.
      // O 'counter-reset: page;' no CSS e 'pageNumber' no span auxiliam o navegador.
    });
    document.getElementById('printDateTime').innerText='Data de Emiss√£o: '+new Date().toLocaleString();
  };
  window.print();
}

// PDF Hist√≥rico
function imprimirHistorico(){
  let novaJan=window.open('','_blank');
  let currentDateTime = new Date().toLocaleString(); // Captura a data/hora uma vez

  // Estilos para o PDF do hist√≥rico, incluindo o zebramento
  let html=`<html><head><title>Hist√≥rico de Movimenta√ß√µes</title><style>
    body{font-family:sans-serif;padding:15px; margin: 0; display: flex; flex-direction: column; min-height: 100vh;}
   .content-wrapper { flex-grow: 1; }
    h1{text-align:center;font-size:24px;font-weight:bold;margin-bottom:20px;}
    table{width:100%;border-collapse:collapse;font-size:12px; margin-top: 15px;}
    th,td{padding:8px;border:1px solid #ddd;text-align:left;}
    th{font-weight:bold; background-color: #f0f0f0;} /* Cor de fundo para o cabe√ßalho da tabela */
    tr:nth-child(even){background:#f5f5f5;} /* Zebramento */
   .footer-pdf{position: fixed; bottom: 0; width: calc(100% - 30px); display: flex; justify-content: space-between; font-size: 10px; border-top: 1px solid #ddd; padding-top: 5px; background: white; margin: 0 15px;}
    /* Para a numera√ß√£o de p√°gina funcionar no PDF da nova janela */
    @page {
      @bottom-right {
        content: "P√°gina " counter(page) " de " counter(pages);
        font-size: 10px;
        font-family: sans-serif;
      }
    }
  </style></head><body>`;
  html+=`<h1>Hist√≥rico de Movimenta√ß√µes Haris</h1><div class="content-wrapper"><table><thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Qtd</th><th>Motivo</th></tr></thead><tbody>`;

  let totalMovimentacoesImpressao = 0;
  historico.forEach(h=>{
      // Filtra o hist√≥rico antes de imprimir no PDF da nova janela
      const termo=document.getElementById('inputBuscaHist').value.toLowerCase();
      const filtro=document.getElementById('filtroCatHist').value;
      if((h.produto.toLowerCase().includes(termo)||h.motivo.toLowerCase().includes(termo))&&(filtro==='Todos'||h.cat===filtro)){
          totalMovimentacoesImpressao++;
          html+=`<tr><td>${h.data}</td><td>${h.produto}</td><td>${h.tipo}</td><td>${h.qtd}</td><td>${h.motivo}</td></tr>`;
      }
  });

  if (totalMovimentacoesImpressao === 0) {
      html += `<tr><td colspan="5" style="text-align:center;">Nenhuma movimenta√ß√£o encontrada para o filtro atual.</td></tr>`;
  }

  html+=`</tbody></table></div>`;
  html+=`<div class="footer-pdf"><span>Data de Emiss√£o: ${currentDateTime}</span><span>Total de Movimenta√ß√µes: ${totalMovimentacoesImpressao}</span></div></body></html>`;
  novaJan.document.write(html);
  novaJan.document.close();
  novaJan.print(); // Invoca a impress√£o da nova janela
}

// Inicializa√ß√£o
initDB();
</script>
</body>
</html>
